"""Initial vulnerability schema

Revision ID: b0b70e588c31
Revises: 
Create Date: 2025-06-13 22:03:54.355717

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'b0b70e588c31'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('cve_intelligence',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('cve_id', sa.String(length=20), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('severity_score', sa.Float(), nullable=True),
    sa.Column('severity_level', sa.String(length=20), nullable=True),
    sa.Column('affected_products', sa.JSON(), nullable=True),
    sa.Column('affected_versions', sa.JSON(), nullable=True),
    sa.Column('affected_languages', sa.JSON(), nullable=True),
    sa.Column('detection_patterns', sa.JSON(), nullable=True),
    sa.Column('exploitation_detected', sa.Boolean(), nullable=True),
    sa.Column('published_date', sa.DateTime(), nullable=True),
    sa.Column('last_modified', sa.DateTime(), nullable=True),
    sa.Column('references', sa.JSON(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_cve_date', 'cve_intelligence', ['published_date'], unique=False)
    op.create_index('idx_cve_severity', 'cve_intelligence', ['severity_level'], unique=False)
    op.create_index(op.f('ix_cve_intelligence_cve_id'), 'cve_intelligence', ['cve_id'], unique=True)
    op.create_index(op.f('ix_cve_intelligence_id'), 'cve_intelligence', ['id'], unique=False)
    op.create_table('projects',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('repository_url', sa.String(length=500), nullable=True),
    sa.Column('languages', sa.JSON(), nullable=True),
    sa.Column('scan_schedule', sa.String(length=50), nullable=True),
    sa.Column('active', sa.Boolean(), nullable=True),
    sa.Column('security_score', sa.Float(), nullable=True),
    sa.Column('last_scan_date', sa.DateTime(), nullable=True),
    sa.Column('vulnerability_trend', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_projects_id'), 'projects', ['id'], unique=False)
    op.create_index(op.f('ix_projects_name'), 'projects', ['name'], unique=True)
    op.create_table('vulnerability_patterns',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('pattern_id', sa.String(length=50), nullable=True),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('severity', sa.String(length=20), nullable=False),
    sa.Column('cwe_id', sa.String(length=20), nullable=True),
    sa.Column('owasp_category', sa.String(length=50), nullable=True),
    sa.Column('languages', sa.JSON(), nullable=True),
    sa.Column('detection_patterns', sa.JSON(), nullable=True),
    sa.Column('ai_features', sa.JSON(), nullable=True),
    sa.Column('fix_guidance', sa.Text(), nullable=True),
    sa.Column('secure_alternatives', sa.JSON(), nullable=True),
    sa.Column('references', sa.JSON(), nullable=True),
    sa.Column('confidence_threshold', sa.Float(), nullable=True),
    sa.Column('false_positive_rate', sa.Float(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_pattern_cwe', 'vulnerability_patterns', ['cwe_id'], unique=False)
    op.create_index('idx_pattern_severity', 'vulnerability_patterns', ['severity'], unique=False)
    op.create_index(op.f('ix_vulnerability_patterns_cwe_id'), 'vulnerability_patterns', ['cwe_id'], unique=False)
    op.create_index(op.f('ix_vulnerability_patterns_id'), 'vulnerability_patterns', ['id'], unique=False)
    op.create_index(op.f('ix_vulnerability_patterns_pattern_id'), 'vulnerability_patterns', ['pattern_id'], unique=True)
    op.create_table('scans',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('scan_id', sa.String(length=100), nullable=True),
    sa.Column('project_id', sa.Integer(), nullable=True),
    sa.Column('scan_type', sa.String(length=20), nullable=True),
    sa.Column('languages_scanned', sa.JSON(), nullable=True),
    sa.Column('files_scanned', sa.Integer(), nullable=True),
    sa.Column('lines_scanned', sa.Integer(), nullable=True),
    sa.Column('start_time', sa.DateTime(), nullable=True),
    sa.Column('end_time', sa.DateTime(), nullable=True),
    sa.Column('duration_seconds', sa.Integer(), nullable=True),
    sa.Column('total_vulnerabilities', sa.Integer(), nullable=True),
    sa.Column('critical_count', sa.Integer(), nullable=True),
    sa.Column('high_count', sa.Integer(), nullable=True),
    sa.Column('medium_count', sa.Integer(), nullable=True),
    sa.Column('low_count', sa.Integer(), nullable=True),
    sa.Column('ai_analysis_count', sa.Integer(), nullable=True),
    sa.Column('average_confidence', sa.Float(), nullable=True),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_scans_id'), 'scans', ['id'], unique=False)
    op.create_index(op.f('ix_scans_project_id'), 'scans', ['project_id'], unique=False)
    op.create_index(op.f('ix_scans_scan_id'), 'scans', ['scan_id'], unique=True)
    op.create_table('vulnerability_detections',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('detection_id', sa.String(length=100), nullable=True),
    sa.Column('file_path', sa.String(length=500), nullable=False),
    sa.Column('line_start', sa.Integer(), nullable=False),
    sa.Column('line_end', sa.Integer(), nullable=False),
    sa.Column('column_start', sa.Integer(), nullable=True),
    sa.Column('column_end', sa.Integer(), nullable=True),
    sa.Column('code_snippet', sa.Text(), nullable=True),
    sa.Column('pattern_id', sa.Integer(), nullable=True),
    sa.Column('severity', sa.String(length=20), nullable=False),
    sa.Column('confidence_score', sa.Float(), nullable=False),
    sa.Column('ai_explanation', sa.Text(), nullable=True),
    sa.Column('ai_confidence', sa.Float(), nullable=True),
    sa.Column('embedding_vector', sa.JSON(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('verified_by_user', sa.Boolean(), nullable=True),
    sa.Column('suppressed', sa.Boolean(), nullable=True),
    sa.Column('suppression_reason', sa.Text(), nullable=True),
    sa.Column('scan_id', sa.Integer(), nullable=True),
    sa.Column('project_id', sa.Integer(), nullable=True),
    sa.Column('detected_at', sa.DateTime(), nullable=True),
    sa.Column('resolved_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['pattern_id'], ['vulnerability_patterns.id'], ),
    sa.ForeignKeyConstraint(['project_id'], ['projects.id'], ),
    sa.ForeignKeyConstraint(['scan_id'], ['scans.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_detection_confidence', 'vulnerability_detections', ['confidence_score'], unique=False)
    op.create_index('idx_detection_project_status', 'vulnerability_detections', ['project_id', 'status'], unique=False)
    op.create_index('idx_detection_status_severity', 'vulnerability_detections', ['status', 'severity'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_confidence_score'), 'vulnerability_detections', ['confidence_score'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_detection_id'), 'vulnerability_detections', ['detection_id'], unique=True)
    op.create_index(op.f('ix_vulnerability_detections_file_path'), 'vulnerability_detections', ['file_path'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_id'), 'vulnerability_detections', ['id'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_project_id'), 'vulnerability_detections', ['project_id'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_scan_id'), 'vulnerability_detections', ['scan_id'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_severity'), 'vulnerability_detections', ['severity'], unique=False)
    op.create_index(op.f('ix_vulnerability_detections_status'), 'vulnerability_detections', ['status'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_vulnerability_detections_status'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_severity'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_scan_id'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_project_id'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_id'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_file_path'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_detection_id'), table_name='vulnerability_detections')
    op.drop_index(op.f('ix_vulnerability_detections_confidence_score'), table_name='vulnerability_detections')
    op.drop_index('idx_detection_status_severity', table_name='vulnerability_detections')
    op.drop_index('idx_detection_project_status', table_name='vulnerability_detections')
    op.drop_index('idx_detection_confidence', table_name='vulnerability_detections')
    op.drop_table('vulnerability_detections')
    op.drop_index(op.f('ix_scans_scan_id'), table_name='scans')
    op.drop_index(op.f('ix_scans_project_id'), table_name='scans')
    op.drop_index(op.f('ix_scans_id'), table_name='scans')
    op.drop_table('scans')
    op.drop_index(op.f('ix_vulnerability_patterns_pattern_id'), table_name='vulnerability_patterns')
    op.drop_index(op.f('ix_vulnerability_patterns_id'), table_name='vulnerability_patterns')
    op.drop_index(op.f('ix_vulnerability_patterns_cwe_id'), table_name='vulnerability_patterns')
    op.drop_index('idx_pattern_severity', table_name='vulnerability_patterns')
    op.drop_index('idx_pattern_cwe', table_name='vulnerability_patterns')
    op.drop_table('vulnerability_patterns')
    op.drop_index(op.f('ix_projects_name'), table_name='projects')
    op.drop_index(op.f('ix_projects_id'), table_name='projects')
    op.drop_table('projects')
    op.drop_index(op.f('ix_cve_intelligence_id'), table_name='cve_intelligence')
    op.drop_index(op.f('ix_cve_intelligence_cve_id'), table_name='cve_intelligence')
    op.drop_index('idx_cve_severity', table_name='cve_intelligence')
    op.drop_index('idx_cve_date', table_name='cve_intelligence')
    op.drop_table('cve_intelligence')
    # ### end Alembic commands ###
